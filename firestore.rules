
/**
 * # Firestore Security Rules for VozGenius
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership model for all personal data,
 * combined with role-based access for administrative functions. The primary goal
 * is to ensure that users can only access and manage their own information,
 * while global, application-wide data is publicly readable but centrally managed.
 *
 * ## Data Structure
 * - `/users/{userId}`: Root path for all user-specific data. Each user has a
 *   document here containing their profile.
 * - `/all-orders/{orderId}`: A top-level collection for ALL user orders. Access
 *   is controlled by a `userId` field within each document.
 * - `/packages/{packageId}`: Top-level collection for publicly viewable credit packages.
 * - `/voices/{voiceId}`: Top-level collection for publicly available text-to-speech voices.
 *
 * ## Key Security Decisions
 * - **Strict User Scoping**: All data within the `/users/{userId}` path is strictly
 *   limited to the authenticated owner of that data tree.
 * - **No User Listing**: Listing documents in the top-level `/users` collection is
 *   explicitly disabled to protect user privacy.
 * - **Public Read-Only Data**: Collections like `/packages` and `/voices` are
 *   publicly readable by any client, but all write operations are restricted
 *   to administrators.
 * - **Role-Based Access Control (RBAC)**: An `isAdmin()` function checks the
 *   authenticated user's email, granting elevated privileges.
 *
 * ## Denormalization for Authorization
 * To ensure fast and secure authorization, user-owned documents like Recording
 * Orders contain a denormalized `userId` field. This allows rules to verify
 * ownership by checking the document's data directly, avoiding costly lookups.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.email == 'josineisilva2@gmail.com';
    }
    
    function isDocumentOwner(doc) {
      return isSignedIn() && request.auth.uid == doc.userId;
    }

    function createsWithMatchingId(docId) {
      return request.resource.data.id == docId;
    }
    
    function createsWithMatchingUserId(userId) {
      return request.resource.data.userId == userId;
    }

    function idIsImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    function userIdIsImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }
    
    // -------------------------------------------------------------------------
    // User Data Rules (/users)
    // -------------------------------------------------------------------------

    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) && createsWithMatchingId(userId);
      allow update: if isOwner(userId) && idIsImmutable();
      allow delete: if isOwner(userId);
    }
    
    // -------------------------------------------------------------------------
    // Global Order Rules (/all-orders)
    // -------------------------------------------------------------------------

    match /all-orders/{orderId} {
      // Users can create their own orders.
      allow create: if isSignedIn() && createsWithMatchingUserId(request.auth.uid);
      
      // Users can read their own orders. Admins can read all orders.
      allow get: if (isDocumentOwner(resource.data) || isAdmin());
      
      // Users can update status on their own orders if they are the owner.
      // Admins can update any field on any order.
      allow update: if (isAdmin() || (isDocumentOwner(resource.data) && userIdIsImmutable()));
      
      // Only admins can delete orders.
      allow delete: if isAdmin();
    }
    
    match /all-orders {
      // Only admins can list all orders. Users can't list from this global collection.
      allow list: if isAdmin();
    }

    // -------------------------------------------------------------------------
    // Global Data Rules (/packages, /voices)
    // -------------------------------------------------------------------------

    match /packages/{packageId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin() && createsWithMatchingId(packageId);
      allow update: if isAdmin() && resource != null && idIsImmutable();
      allow delete: if isAdmin() && resource != null;
    }

    match /voices/{voiceId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin() && createsWithMatchingId(voiceId);
      allow update: if isAdmin() && resource != null && idIsImmutable();
      allow delete: if isAdmin() && resource != null;
    }
  }
}
