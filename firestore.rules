/**
 * @fileoverview Firestore Security Rules for Voice Actor Demos application.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model where "admins" have full
 * CRUD access to voice actors, demo types, and voice actor demos, while all users
 * can read this information. An admin is identified by a custom claim `isAdmin` set to `true`.
 *
 * Data Structure:
 * The database consists of three main collections:
 * - /voice_actors/{voiceActorId}: Stores voice actor profiles.
 * - /demo_types/{demoTypeId}: Stores demo types.
 * - /voice_actors/{voiceActorId}/demos/{demoId}: Stores voice actor demos, nested under
 *   the corresponding voice actor document.
 *
 * Key Security Decisions:
 * - All read operations are publicly accessible to all authenticated users.
 * - All write operations (create, update, delete) are restricted to admins only.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows admins to manage voice actor profiles and users to read them.
     * @path /voice_actors/{voiceActorId}
     * @allow (get, list): Any authenticated user can read voice actor profiles.
     * @allow (create, update, delete): Only admins can create, update, or delete voice actor profiles.
     */
    match /voice_actors/{voiceActorId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * @description Allows admins to manage demo types and users to read them.
     * @path /demo_types/{demoTypeId}
     * @allow (get, list): Any authenticated user can read demo types.
     * @allow (create, update, delete): Only admins can create, update, or delete demo types.
     */
    match /demo_types/{demoTypeId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * @description Allows admins to manage voice actor demos and users to read them.
     * @path /voice_actors/{voiceActorId}/demos/{demoId}
     * @allow (get, list): Any authenticated user can read voice actor demos.
     * @allow (create, update, delete): Only admins can create, update, or delete voice actor demos.
     */
    match /voice_actors/{voiceActorId}/demos/{demoId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    /**
     * @description User profiles are private, only the owner can read/write.
     * @path /users/{userId}
     */
    match /users/{userId} {
        allow read, write: if request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is an admin by looking for a custom claim.
     * @return {bool} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return request.auth.token.isAdmin == true;
    }
  }
}
